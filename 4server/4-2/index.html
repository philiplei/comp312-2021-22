<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.87.0" />
    <meta name="description" content="">
<meta name="author" content="Philip Lei">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>4-2 Asynchronous callback :: COMP312 notes</title>

    
    <link href="/css/nucleus.css?1634349523" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1634349523" rel="stylesheet">
    <link href="/css/featherlight.min.css?1634349523" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1634349523" rel="stylesheet">
    <link href="/css/auto-complete.css?1634349523" rel="stylesheet">
    <link href="/css/theme.css?1634349523" rel="stylesheet">
    <link href="/css/tabs.css?1634349523" rel="stylesheet">
    <link href="/css/hugo-theme.css?1634349523" rel="stylesheet">
    
    <link href="/css/theme-green.css?1634349523" rel="stylesheet">
    
    

    <script src="/js/jquery.min.js?1634349523"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/4server/4-2/">
    <nav id="sidebar" class="">
  
  
  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://philiplei.github.io">
    <i class="fas fa-file-code"></i> <b>COMP312 course notes</b>
</a>

    </div>
    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href="/"><i class="fas fa-home"></i> Home</a>
        </li>
      </ul>
    </section>
  

  <div class="highlightable">
    <ul class="topics">
      
        
        





  
		
    
      
      
      <li data-nav-id="/2basic/" title="JavaScript basics" class="dd-item">
        <a href="/2basic/">
          
JavaScript basics

          
        </a>
        <ul>
          
          
          

          
            
            





  
		
    
      <li data-nav-id="/2basic/2-1/" title="2-1 Basic data types and control" class="dd-item">
        <a href="/2basic/2-1/">
          
2-1 Basic data types and control

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/2basic/2-2/" title="2-2 Arrays" class="dd-item">
        <a href="/2basic/2-2/">
          
2-2 Arrays

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/2basic/2-3/" title="2-3 Functions" class="dd-item">
        <a href="/2basic/2-3/">
          
2-3 Functions

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/2basic/2-4/" title="2-4 Objects as data structure" class="dd-item">
        <a href="/2basic/2-4/">
          
2-4 Objects as data structure

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/2basic/2-5/" title="2-5 Functions as objects and callbacks" class="dd-item">
        <a href="/2basic/2-5/">
          
2-5 Functions as objects and callbacks

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/2basic/2-6/" title="2-6 Objects with methods" class="dd-item">
        <a href="/2basic/2-6/">
          
2-6 Objects with methods

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/2basic/2-7/" title="2-7 Defining class" class="dd-item">
        <a href="/2basic/2-7/">
          
2-7 Defining class

          
        </a>
      </li>
    
  

            
          
        </ul>
      </li>
    
  

        
        





  
		
    
      
      
      <li data-nav-id="/3client/" title="Client-side programming" class="dd-item">
        <a href="/3client/">
          
Client-side programming

          
        </a>
        <ul>
          
          
          

          
            
            





  
		
    
      <li data-nav-id="/3client/3-1/" title="3-1 Background" class="dd-item">
        <a href="/3client/3-1/">
          
3-1 Background

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/3client/3-2/" title="3-2 Vue application basics" class="dd-item">
        <a href="/3client/3-2/">
          
3-2 Vue application basics

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/3client/3-3/" title="3-3 Dynamic structure in template" class="dd-item">
        <a href="/3client/3-3/">
          
3-3 Dynamic structure in template

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/3client/3-4/" title="3-4 Events, methods and component lifecycle" class="dd-item">
        <a href="/3client/3-4/">
          
3-4 Events, methods and component lifecycle

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/3client/3-5/" title="3-5 Form controls and bi-directional binding" class="dd-item">
        <a href="/3client/3-5/">
          
3-5 Form controls and bi-directional binding

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/3client/3-6/" title="3-6 Component: motivation and features" class="dd-item">
        <a href="/3client/3-6/">
          
3-6 Component: motivation and features

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/3client/3-7/" title="3-7 Vue projects and build tools" class="dd-item">
        <a href="/3client/3-7/">
          
3-7 Vue projects and build tools

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/3client/3-8/" title="3-8 Make your own components" class="dd-item">
        <a href="/3client/3-8/">
          
3-8 Make your own components

          
        </a>
      </li>
    
  

            
          
        </ul>
      </li>
    
  

        
        





  
		
    
      
      
      <li data-nav-id="/4server/" title="Server-side programming" class="dd-item parent">
        <a href="/4server/">
          
Server-side programming

          
        </a>
        <ul>
          
          
          

          
            
            





  
		
    
      <li data-nav-id="/4server/4-1/" title="4-1 Node.js primer" class="dd-item">
        <a href="/4server/4-1/">
          
4-1 Node.js primer

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/4server/4-2/" title="4-2 Asynchronous callback" class="dd-item active">
        <a href="/4server/4-2/">
          
4-2 Asynchronous callback

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/4server/4-3/" title="4-3 Promise, await and async" class="dd-item">
        <a href="/4server/4-3/">
          
4-3 Promise, await and async

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/4server/4-4/" title="4-4 Modules, import and export" class="dd-item">
        <a href="/4server/4-4/">
          
4-4 Modules, import and export

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/4server/4-5/" title="4-5 Database access" class="dd-item">
        <a href="/4server/4-5/">
          
4-5 Database access

          
        </a>
      </li>
    
  

            
          
        </ul>
      </li>
    
  

        
        





  
		
    
      
      
      <li data-nav-id="/5appserver/" title="App server programming" class="dd-item">
        <a href="/5appserver/">
          
App server programming

          
        </a>
        <ul>
          
          
          

          
            
            





  
		
    
      <li data-nav-id="/5appserver/5-1/" title="5-1 Web API, concepts" class="dd-item">
        <a href="/5appserver/5-1/">
          
5-1 Web API, concepts

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/5appserver/5-2/" title="5-2 RPC Web API" class="dd-item">
        <a href="/5appserver/5-2/">
          
5-2 RPC Web API

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/5appserver/5-3/" title="5-3 REST Web API" class="dd-item">
        <a href="/5appserver/5-3/">
          
5-3 REST Web API

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/5appserver/5-4/" title="5-4 Making HTTP requests in client" class="dd-item">
        <a href="/5appserver/5-4/">
          
5-4 Making HTTP requests in client

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/5appserver/5-5/" title="5-5 Web app server" class="dd-item">
        <a href="/5appserver/5-5/">
          
5-5 Web app server

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/5appserver/5-6/" title="5-6 Implementing REST API" class="dd-item">
        <a href="/5appserver/5-6/">
          
5-6 Implementing REST API

          
        </a>
      </li>
    
  

            
          
        </ul>
      </li>
    
  

        
      
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/4server/'>Server-side programming</a> > 4-2 Asynchronous callback
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#asynchronous-io-handling">Asynchronous I/O handling</a></li>
    <li><a href="#sequential-io-operations">Sequential I/O operations</a></li>
    <li><a href="#callback-hell">Callback hell</a></li>
    <li><a href="#events-and-event-handlers">Events and event handlers</a></li>
    <li><a href="#downloadable-example">Downloadable example</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              4-2 Asynchronous callback
            </h1>
          

        


<h2 id="asynchronous-io-handling">Asynchronous I/O handling</h2>
<p>Input / output operations, e.g. file reading/writing and network transactions, are much slower than CPU. Introductory programming examples (e.g. in Java and Python) typically use <strong>synchronous function call</strong> to perform I/O. Each file operation takes  relatively long time to complete, and while the function call is waiting the I/O completion, the process / thread is <em>blocked</em>. When the I/O is completed, the program can continue to the next line in the program.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-Java" data-lang="Java"><span style="color:#f92672">import</span> java.io.File<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.Scanner<span style="color:#f92672">;</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JavaExample</span>
<span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception
  <span style="color:#f92672">{</span>
    <span style="color:#75715e">// wait some time for the file open
</span><span style="color:#75715e"></span>    File file <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test.txt&#34;</span><span style="color:#f92672">);</span>
    Scanner sc <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Scanner<span style="color:#f92672">(</span>file<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>sc<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNextLine</span><span style="color:#f92672">())</span>
      <span style="color:#75715e">// wait some time to read some text from file
</span><span style="color:#75715e"></span>      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>sc<span style="color:#f92672">.</span><span style="color:#a6e22e">nextLine</span><span style="color:#f92672">());</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>However, there is only 1 thread to run JavaScript code in most platforms (one thread per browser window, one thread per Node.js program). If this thread blocks to wait for I/O completion, the whole Node process is blocked and cannot process other events. Consider the following example.</p>
<blockquote>
<p>There is exception. A Node.js that can only use 1 thread results in bad CPU utilization of multi-core CPUs. So modern JavaScript platforms support multiprocessing, e.g. <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Web workers</a> in web browsers, and <a href="https://nodejs.org/api/worker_threads.html">worker threads</a> in Node.js.</p>
</blockquote>
<p>Therefore, JavaScript libraries employ <strong>asynchronous function call</strong> to handle I/O completion. Consider the following example, in which the program sends a DNS query to a name server to find the IP addresses of a domain name. The function call <code>dns.resolve()</code> <em>starts</em> the network transaction (i.e. sends a DNS query), and <em>registers</em> a callback function for I/O completion. But it <em>does not block</em>.  When the name server returns a reply, the event loop calls the callback function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#75715e">/// p111-a.mjs
</span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">dns</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;dns&#39;</span>;
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">govHost</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;www.gov.mo&#34;</span>;

<span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">govHost</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">records</span>) =&gt; {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>); <span style="color:#66d9ef">return</span>;
  }
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">govHost</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> resolves to </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">records</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
});

<span style="color:#75715e">// this runs before we got an answer from a name server
</span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>;

<span style="color:#75715e">// event loop
</span></code></pre></div><p>Similarly, file input/output usually use asynchronous callback to handle I/O completion. For more information, read online reference for <a href="https://nodejs.org/api/fs.html#fs_fs_readfile_path_options_callback">fs.readFile</a> and <a href="https://nodejs.org/api/fs.html#fs_fs_writefile_file_data_options_callback">fs.writeFile</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#75715e">// p112.mjs
</span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">fs</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;fs&#39;</span>;
<span style="color:#75715e">/* function getPrime() returns an array of prime numbers */</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">textData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">genPrime</span>(<span style="color:#ae81ff">200</span>).<span style="color:#a6e22e">toString</span>();
<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">writeFile</span>(<span style="color:#e6db74">&#39;./prime.txt&#39;</span>, <span style="color:#a6e22e">textData</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>, (<span style="color:#a6e22e">err</span>)=&gt;{
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">err</span>;
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;Some prime numbers are written to prime.txt&#39;</span>);
});
<span style="color:#75715e">// at this point, file write is still in progress
</span><span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// event loop waits for writeFile to finish
</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#75715e">// p113.mjs
</span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">fs</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;fs&#39;</span>;
<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readFile</span>(<span style="color:#e6db74">&#39;./prime.txt&#39;</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>)=&gt;{
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">err</span>;
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">primes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;,&#39;</span>);
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">primes</span>.<span style="color:#a6e22e">length</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> prime numbers found in prime.txt.`</span>);
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`The last 5 are </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">primes</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
});
<span style="color:#75715e">// ...
</span><span style="color:#75715e">// event loop waits for readFile to finish
</span></code></pre></div><p>The three I/O operation above (<code>dns.resolve</code>, <code>fs.readFile</code>, <code>fs.writeFile</code>) may either fails with an <code>Error</code> or succeeds and return the data requested. Node.js typically uses completion callback with <em>two parameters</em> to handle these. The first is often an <code>Error</code> object <code>err</code> to report I/O error. If no error has occurred and the I/O operation completes successfully, <code>err</code> equals <code>null</code> or <code>undefined</code>, and the result of the I/O operation is given in the second parameter.</p>
<blockquote>
<p>In the examples, we <code>throw</code> the error object while the event loop calls the callback function. Since the event loop does not catch any exception, throwing the error object will abort the Node.js process.</p>
</blockquote>
<p>And remember, I/O completion callbacks usually are called by the event loop, and usually after all statements of the JavaScript program has executed. In this aspect, completion callbacks are similar to the callbacks in one-time timers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#a6e22e">setTimeout</span>( 
  <span style="color:#75715e">/* this callback runs 10min later, after all the statements below */</span>
  ()=&gt;{  },
  <span style="color:#ae81ff">10</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>
);
<span style="color:#75715e">// ...
</span><span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// event loop
</span></code></pre></div><h2 id="sequential-io-operations">Sequential I/O operations</h2>
<p>The execution time of asynchronous callbacks make the proper sequencing of I/O operations confusing to beginning JavaScript programmers. To properly order two I/O operations, you often need to put the second I/O operation inside the callback of the first I/O operation. Consider the following example of copying the file <code>mpi-info.txt</code> to <code>copy-mpi-info.txt</code>. <a href="/chap4/p115.mjs">example p115.mjs</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-JavaScript" data-lang="JavaScript"><span style="color:#75715e">// p115.mjs - file copy
</span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">fs</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;fs&#39;</span>;

<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readFile</span>(<span style="color:#e6db74">&#39;mpi-info.txt&#39;</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">err</span>;
  <span style="color:#75715e">// at this moment, file read is done
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// `data` contains content of the input file
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">writeFile</span>(<span style="color:#e6db74">&#39;copy-mpi-info.txt&#39;</span>, <span style="color:#a6e22e">data</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>, (<span style="color:#a6e22e">err</span>) =&gt; {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">err</span>;
  });
});
</code></pre></div><p>If the two calls of <code>readFile</code> and <code>writeFile</code> are not nested, but put into a sequence as in <a href="/chap4/p116-mistake.mjs">example p116-mistake.mjs</a>, <code>writeFile</code> will not receive any data from <code>readFile</code>.</p>
<h2 id="callback-hell">Callback hell</h2>
<p>In general, doing some I/O operations in sequence would involve nesting callback functions. The result is sometimes known as <strong>callback hell</strong> in the Node community.  We&rsquo;ll explain a modern JavaScript language feature called Promise that mitigates this problem.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-JavaScript" data-lang="JavaScript"><span style="color:#75715e">// p117.mjs - concatenate two files
</span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">fs</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;fs&#39;</span>;

<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readFile</span>(<span style="color:#e6db74">&#39;p115.mjs&#39;</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">file1Data</span>)=&gt;{
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">err</span>;
  <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readFile</span>(<span style="color:#e6db74">&#39;p116-mistake.mjs&#39;</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">file2Data</span>)=&gt;{
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">err</span>;
    <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">writeFile</span>(<span style="color:#e6db74">&#39;combined.txt&#39;</span>, <span style="color:#a6e22e">file1Data</span><span style="color:#f92672">+</span><span style="color:#a6e22e">file2Data</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>, (<span style="color:#a6e22e">err</span>)=&gt;{
      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">err</span>;
    });
  });
});
</code></pre></div><h2 id="events-and-event-handlers">Events and event handlers</h2>
<p>On the other hand, some I/O processes detect some kind of event several times (0, 1, 2 or more), and need to run a callback function asynchronously to handle each event. For example, a web server runs a callback whenever it receives an HTTP request from a browser. The following example uses the built-in module <code>http</code> to write a simple web server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#75715e">// p114.mjs
</span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">http</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;http&#39;</span>;
<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">createServer</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) {
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">writeHead</span>(<span style="color:#ae81ff">200</span>, {<span style="color:#e6db74">&#39;Content-Type&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;text/plain&#39;</span>});
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">write</span>(<span style="color:#e6db74">&#34;Hello browser&#34;</span>);
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">end</span>();
});
<span style="color:#75715e">// ...
</span></code></pre></div><p>Try to run the example <code>p114.mjs</code>. The HTTP <code>server</code> actually support several more kinds of events, and you can register event handler for each kind of event.</p>
<p>Event handlers are similar to the callback function of a periodic timer. They are also similar to event handlers in web browsers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#a6e22e">setInterval</span>( 
  <span style="color:#75715e">/* this callback runs every minute, after all the statements below */</span>
  ()=&gt;{  },
  <span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>
);
<span style="color:#75715e">// ...
</span><span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// event loop
</span></code></pre></div><h2 id="downloadable-example">Downloadable example</h2>
<p>The example source files are <a href="/chap4/chap4-2.zip">available here</a>.</p>



<footer class="footline">
    
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        
        
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1634349523"></script>
    <script src="/js/perfect-scrollbar.min.js?1634349523"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1634349523"></script>
    <script src="/js/jquery.sticky.js?1634349523"></script>
    <script src="/js/jquery.svg.pan.zoom.js?1634349523"></script>
    <script src="/js/featherlight.min.js?1634349523"></script>
    <script src="/js/modernizr.custom-3.6.0.js?1634349523"></script>
    
        
            <script src="/js/mermaid.min.js?1634349523"></script>
        
        
            
        
        <script>
            if (mermaid) {
                mermaid.mermaidAPI.initialize( Object.assign( { "securityLevel": "antiscript" }, JSON.parse("{ \"startOnLoad\": true }"), { startOnLoad: false } ) );
            }
        </script>
    
    <script src="/js/relearn.js?1634349523"></script>
    

  </body>
</html>

