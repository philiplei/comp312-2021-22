<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.87.0" />
    <meta name="description" content="">
<meta name="author" content="Philip Lei">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>5-5 Web app server :: COMP312 notes</title>

    
    <link href="/css/nucleus.css?1633771374" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1633771374" rel="stylesheet">
    <link href="/css/featherlight.min.css?1633771374" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1633771374" rel="stylesheet">
    <link href="/css/auto-complete.css?1633771374" rel="stylesheet">
    <link href="/css/theme.css?1633771374" rel="stylesheet">
    <link href="/css/tabs.css?1633771374" rel="stylesheet">
    <link href="/css/hugo-theme.css?1633771374" rel="stylesheet">
    
    <link href="/css/theme-green.css?1633771374" rel="stylesheet">
    
    

    <script src="/js/jquery.min.js?1633771374"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/appserver/5-5/">
    <nav id="sidebar" class="">
  
  
  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://philiplei.github.io">
    <i class="fas fa-file-code"></i> <b>COMP312 course notes</b>
</a>

    </div>
    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href="/"><i class="fas fa-home"></i> Home</a>
        </li>
      </ul>
    </section>
  

  <div class="highlightable">
    <ul class="topics">
      
        
        





  
		
    
      
      
      <li data-nav-id="/basic/" title="JavaScript basics" class="dd-item">
        <a href="/basic/">
          
JavaScript basics

          
        </a>
        <ul>
          
          
          

          
            
            





  
		
    
      <li data-nav-id="/basic/2-1/" title="2-1 Basic data types and control" class="dd-item">
        <a href="/basic/2-1/">
          
2-1 Basic data types and control

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/basic/2-2/" title="2-2 Arrays" class="dd-item">
        <a href="/basic/2-2/">
          
2-2 Arrays

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/basic/2-3/" title="2-3 Functions" class="dd-item">
        <a href="/basic/2-3/">
          
2-3 Functions

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/basic/2-4/" title="2-4 Objects as data structure" class="dd-item">
        <a href="/basic/2-4/">
          
2-4 Objects as data structure

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/basic/2-5/" title="2-5 Functions as objects and callbacks" class="dd-item">
        <a href="/basic/2-5/">
          
2-5 Functions as objects and callbacks

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/basic/2-6/" title="2-6 Objects with methods" class="dd-item">
        <a href="/basic/2-6/">
          
2-6 Objects with methods

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/basic/2-7/" title="2-7 Defining class" class="dd-item">
        <a href="/basic/2-7/">
          
2-7 Defining class

          
        </a>
      </li>
    
  

            
          
        </ul>
      </li>
    
  

        
        





  
		
    
      
      
      <li data-nav-id="/client/" title="Client-side programming" class="dd-item">
        <a href="/client/">
          
Client-side programming

          
        </a>
        <ul>
          
          
          

          
            
            





  
		
    
      <li data-nav-id="/client/3-1/" title="3-1 Background" class="dd-item">
        <a href="/client/3-1/">
          
3-1 Background

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/client/3-2/" title="3-2 Vue application basics" class="dd-item">
        <a href="/client/3-2/">
          
3-2 Vue application basics

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/client/3-3/" title="3-3 Dynamic structure in template" class="dd-item">
        <a href="/client/3-3/">
          
3-3 Dynamic structure in template

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/client/3-4/" title="3-4 Events, methods and component lifecycle" class="dd-item">
        <a href="/client/3-4/">
          
3-4 Events, methods and component lifecycle

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/client/3-5/" title="3-5 Form controls and bi-directional binding" class="dd-item">
        <a href="/client/3-5/">
          
3-5 Form controls and bi-directional binding

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/client/3-6/" title="3-6 Component: motivation and features" class="dd-item">
        <a href="/client/3-6/">
          
3-6 Component: motivation and features

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/client/3-7/" title="3-7 Vue projects and build tools" class="dd-item">
        <a href="/client/3-7/">
          
3-7 Vue projects and build tools

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/client/3-8/" title="3-8 Make your own components" class="dd-item">
        <a href="/client/3-8/">
          
3-8 Make your own components

          
        </a>
      </li>
    
  

            
          
        </ul>
      </li>
    
  

        
        





  
		
    
      
      
      <li data-nav-id="/server/" title="Server-side programming" class="dd-item">
        <a href="/server/">
          
Server-side programming

          
        </a>
        <ul>
          
          
          

          
            
            





  
		
    
      <li data-nav-id="/server/4-1/" title="4-1 Node.js primer" class="dd-item">
        <a href="/server/4-1/">
          
4-1 Node.js primer

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/server/4-2/" title="4-2 Asynchronous callback" class="dd-item">
        <a href="/server/4-2/">
          
4-2 Asynchronous callback

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/server/4-3/" title="4-3 Promise, await and async" class="dd-item">
        <a href="/server/4-3/">
          
4-3 Promise, await and async

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/server/4-4/" title="4-4 Modules, import and export" class="dd-item">
        <a href="/server/4-4/">
          
4-4 Modules, import and export

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/server/4-5/" title="4-5 Database access" class="dd-item">
        <a href="/server/4-5/">
          
4-5 Database access

          
        </a>
      </li>
    
  

            
          
        </ul>
      </li>
    
  

        
        





  
		
    
      
      
      <li data-nav-id="/appserver/" title="App server programming" class="dd-item parent">
        <a href="/appserver/">
          
App server programming

          
        </a>
        <ul>
          
          
          

          
            
            





  
		
    
      <li data-nav-id="/appserver/5-1/" title="5-1 Web API, concepts" class="dd-item">
        <a href="/appserver/5-1/">
          
5-1 Web API, concepts

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/appserver/5-2/" title="5-2 RPC Web API" class="dd-item">
        <a href="/appserver/5-2/">
          
5-2 RPC Web API

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/appserver/5-3/" title="5-3 REST Web API" class="dd-item">
        <a href="/appserver/5-3/">
          
5-3 REST Web API

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/appserver/5-4/" title="5-4 Making HTTP requests in client" class="dd-item">
        <a href="/appserver/5-4/">
          
5-4 Making HTTP requests in client

          
        </a>
      </li>
    
  

            
            





  
		
    
      <li data-nav-id="/appserver/5-5/" title="5-5 Web app server" class="dd-item active">
        <a href="/appserver/5-5/">
          
5-5 Web app server

          
        </a>
      </li>
    
  

            
          
        </ul>
      </li>
    
  

        
      
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/appserver/'>App server programming</a> > 5-5 Web app server
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#handling-requests-at-routes">Handling requests at routes</a></li>
    <li><a href="#making-responses">Making responses</a></li>
    <li><a href="#order-of-routes">Order of routes</a></li>
    <li><a href="#handling-url-encoded-payload">Handling URL-encoded payload</a></li>
    <li><a href="#middlewares">Middlewares</a></li>
    <li><a href="#downloadable-sample-code">Downloadable sample code</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              5-5 Web app server
            </h1>
          

        


<p>Express.js <a href="http://expressjs.com/">(official website)</a> is a web framework to simplify development of Web applications. It supports:</p>
<ul>
<li>Routing – different request processing based on URL patterns</li>
<li>Middleware – chainable processing of requests and responses</li>
<li>Template – generate HTML output from variables</li>
</ul>
<p>This lab covers how to define routes to capture HTTP requests for a web app / service endpoints. In addition, we&rsquo;ll discuss how to generate simple HTTP responses.</p>
<h2 id="handling-requests-at-routes">Handling requests at routes</h2>
<p>This example shows the basic structure of an Express app.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-JavaScript" data-lang="JavaScript"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">express</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;express&#39;</span>;
<span style="color:#75715e">// create an Express application, which will handle HTTP requests
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">express</span>();

<span style="color:#75715e">// a route in the app, which handles GET request for the path &#39;/&#39;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;hello world&#39;</span>);
});

<span style="color:#75715e">// more routes ...
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// start listening at TCP port 3000
</span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">3000</span>);
</code></pre></div><p>When a web app receives an HTTP request, it has to decide how to handle the request, and return the result as an HTTP response.  Such decision usually depends on the HTTP method (e.g. <code>GET</code>, <code>POST</code>, <code>PUT</code>) and the path in the URL (e.g. &ldquo;/about.html&rdquo;).   The combination of HTTP method and the URL path is usually referred to as an <strong>endpoint</strong> of the web app or web API.</p>
<p>In an Express app, we define a <strong>route</strong> to describe how to process HTTP requests at an endpoint.
The general syntax is <code>app.HTTP_method(path, callback)</code>, where <code>HTTP_method</code> stands for <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>PATCH</code>, <code>DELETE</code>, etc.
The callback is sometimes called <strong>route handler</strong>, and can take 2 or more parameters.  Often, we only use the first two parameters called <code>req</code> and <code>res</code>: <code>req</code> refers to the incoming HTTP request, and <code>res</code> is an object that is used to build the HTTP response. The following is a route for GET request at URL &lsquo;/about.html&rsquo;. The route returns a text response.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-JavaScript" data-lang="JavaScript"><span style="color:#75715e">// app is an Express app
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/about.html&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#75715e">// When the Express app receives a GET request
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// for the path &#39;/about.html&#39;, it returns a text response
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;This is a simple example of route&#39;</span>)
});
</code></pre></div><p>Some web apps include parameters in the URL path. You can easily extract these parameters in Express routes. Consider the sample code below, which shows a web app to check lecture hours. When the app receives a GET request for the path &lsquo;/lecture/comp312&rsquo;, it returns a response of its lecture hours. The parameters are available in the object <code>req.params</code>.</p>
<p>Check the source code of <a href="/chap5/p550-express/app1.mjs">app1.mjs</a> for more detail.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-JavaScript" data-lang="JavaScript"><span style="color:#75715e">// retrieve the lecture time
</span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/lecture/:code&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#75715e">// in a real app, we&#39;d query a database ...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">code</span><span style="color:#f92672">==</span><span style="color:#e6db74">&#39;comp312&#39;</span>) {
    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;Tue, Thu: 10:00-11:30am&#39;</span>)
  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">code</span><span style="color:#f92672">==</span><span style="color:#e6db74">&#39;comp311&#39;</span>) {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  }
})
</code></pre></div><p>The above only describes the basics of routing in Express. Refer to the <a href="http://expressjs.com/en/guide/routing.html">online guide</a> for more possibilities.</p>
<h2 id="making-responses">Making responses</h2>
<p>You can use the <code>res</code> object in the route callback to build a response. <a href="http://expressjs.com/en/4x/api.html#res">(online reference)</a> The <code>res</code> object has several common methods:</p>
<ul>
<li>
<p>to set status code and headers</p>
<ul>
<li><code>res.status(code)</code> sets the HTTP response code</li>
<li><code>res.type(type)</code> sets the Content-Type of the response</li>
<li><code>res.append(field, [value])</code> appends a header with the given values</li>
<li><code>res.cookie(name, value)</code> sets a cookie</li>
</ul>
</li>
<li>
<p>to send content in response body</p>
<ul>
<li><code>res.send(body)</code> sends the response body. If <code>body</code> is a string, <code>text/html</code> is assumed. If <code>body</code> is a JavaScript object, the method converts it to a JSON string (<code>JSON.stringify()</code>) and use the Content type <code>application/json</code>.</li>
<li><code>res.json(body)</code> returns the data as JSON payload</li>
<li><code>res.sendFile(path)</code> returns a file as response. The method determines a suitable MIME type based on file type.</li>
<li><code>res.redirect([status], path)</code> redirects to the given URL</li>
<li><code>res.end()</code> usually used to send the response with an empty body</li>
</ul>
</li>
</ul>
<p>Some of these methods can be chained.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-JavaScript" data-lang="JavaScript"><span style="color:#75715e">// retrieve the lecture time
</span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/no-such-resource&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">404</span>).<span style="color:#a6e22e">end</span>()
})
</code></pre></div><p>Check the source code of <a href="/chap5/p550-express/app2.mjs">app2.mjs</a> for demonstration of how to build responses with these methods.</p>
<h2 id="order-of-routes">Order of routes</h2>
<p><strong>The order of routes is significant!</strong>  An Express app checks the routes in the order they are defined. When a route matches the HTTP methods and URL path, the Express app executes its callback function to handle the request.  The callback usually returns an HTTP response with <code>res.send()</code> or similar methods. When a response is returned, the Express app will <strong>stop</strong> checking the remaining routes. Once a response body is sent, it is said to have stopped the request-response cycle in Express. Express will not search the remaining routes (or middlewares) for the current request, and the processing of the request is completed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-JavaScript" data-lang="JavaScript"><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/lecture/comp312&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#75715e">// special response for comp312
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;...&#39;</span>);
});

<span style="color:#75715e">// retrieve the lecture time
</span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/lecture/:code&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#75715e">// search database, return a response
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;...&#39;</span>);
});

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/lecture/comp113&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#75715e">// special response for comp113. But sorry, this route never runs!
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;...&#39;</span>);
});
</code></pre></div><h2 id="handling-url-encoded-payload">Handling URL-encoded payload</h2>
<p>Express decodes the query string of the request URL and deserializes it into a JavaScript object at <code>req.query</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#75715e">// handle requests like GET /add?a=3&amp;b=5
</span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/add&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> parseFloat(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">a</span>);
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> parseFloat(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">b</span>);
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({
    <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GET&#39;</span>,
    <span style="color:#a6e22e">a</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">sum</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">a</span><span style="color:#f92672">+</span><span style="color:#a6e22e">b</span>  
  });
});
</code></pre></div><p>To handle URL-encoded payload in request body, e.g. in <code>POST</code> requests, you need to let a middleware to do the decoding <em>before</em> the route to process the data. The middleware <code>express.urlencoded</code> deserializes the URL-encoded payload into a JavaScript object at <code>req.body</code>. (Similarly, there is a built-in middleware <code>express.json</code> to deserialize JSON payload.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">express</span>.<span style="color:#a6e22e">urlencoded</span>({<span style="color:#a6e22e">extended</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>}));

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#39;/add&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> parseFloat(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">a</span>);
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> parseFloat(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">b</span>);
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({
    <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;POST&#39;</span>,
    <span style="color:#a6e22e">a</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">sum</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">a</span><span style="color:#f92672">+</span><span style="color:#a6e22e">b</span>  
  });
});
</code></pre></div><p>Check the source code of <a href="/chap5/p550-express/app3.mjs">app3.mjs</a> for demonstration of how to build responses with these methods.</p>
<h2 id="middlewares">Middlewares</h2>
<p>In Express.js, both middlewares and route handlers are callback functions. When you set up an Express app, you register middlewares with <code>app.use()</code> and route handlers with <code>app.get()</code> (and also, for other HTTP method, e.g. <code>app.post()</code>) in sequential order to build a middleware stack.</p>
<p>Refer to the figures in the article <a href="https://medium.com/@viral_shah/express-middlewares-demystified-f0c2c37ea6a1">Express Middlewares, Demystified</a> and <a href="https://dev.to/ghvstcode/understanding-express-middleware-a-beginners-guide-g73">Understanding Express Middleware</a>.</p>
<p>When an Express app server receives an HTTP request, it will pass the request to each callback in the middleware stack in order. When a callback calls <code>next()</code>, control will be transferred to the next in the stack. On the other hand, if a callback returns an HTTP response to the client (e.g. by calling <code>res.json()</code>), it will stop the request-response cycle.</p>
<p>During the request-response cycle, a middleware function can make changes to the <code>req</code> or <code>res</code> object, send a response body to complete the processing of the current request, or pass the control to the next callback in the middleware stack. For more information, please refer to the official guide on <a href="https://expressjs.com/en/guide/writing-middleware.html">writing middlewares</a> and <a href="https://expressjs.com/en/guide/using-middleware.html">using middlewares</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>( (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">next</span>) =&gt; {
  <span style="color:#75715e">// after logging this request, pass to next
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">method</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> - </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">baseUrl</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
  <span style="color:#a6e22e">next</span>();
});

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>( (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">next</span>) =&gt; {
  <span style="color:#75715e">// has this user logged in?
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">sessionActive</span>) {
    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">redirect</span>(<span style="color:#e6db74">&#39;/login.html&#39;</span>); <span style="color:#66d9ef">return</span>;
  }
  <span style="color:#a6e22e">next</span>();
});

<span style="color:#75715e">// other routes and middlewares
</span></code></pre></div><hr>
<p>A useful built-in middleware is <code>express.static</code>. This searches a given directory to find files that match the path in the URL being request. If found, the middleware returns the file as a response. Otherwise, it pass control to the next callback in the middleware stack. <code>express.static</code> is effectively a mini web server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:3;-o-tab-size:3;tab-size:3"><code class="language-js" data-lang="js"><span style="color:#75715e">// most routes and middlewares should be placed before the static middleware
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">express</span>.<span style="color:#66d9ef">static</span>(<span style="color:#ae81ff">__</span><span style="color:#a6e22e">dirname</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/public&#39;</span>));

<span style="color:#75715e">// if no file matches the request URL, the following routes will be checked.
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;special_page.html&#39;</span>, (<span style="color:#a6e22e">req</span>,<span style="color:#a6e22e">res</span>) =&gt; { });
</code></pre></div><p>If a file with the same name as a route (e.g. <code>special_page.html</code>) is added to the <code>/public</code> folder, the <code>express.static</code> middleware will stop the request-response cycle, and that route will no longer be used. Therefore, we usually put the <code>static</code> middleware near the bottom of the middleware stack.</p>
<p>Check the source code of <a href="/chap5/p550-express/app4.mjs">app4.mjs</a> for demonstration of how to build responses with these methods.</p>
<h2 id="downloadable-sample-code">Downloadable sample code</h2>
<ul>
<li><a href="/chap5/p550-express.zip">p550-express.zip</a> - a project containing all example in this page.</li>
</ul>



<footer class="footline">
    
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        
        
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1633771374"></script>
    <script src="/js/perfect-scrollbar.min.js?1633771374"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1633771374"></script>
    <script src="/js/jquery.sticky.js?1633771374"></script>
    <script src="/js/jquery.svg.pan.zoom.js?1633771374"></script>
    <script src="/js/featherlight.min.js?1633771374"></script>
    <script src="/js/modernizr.custom-3.6.0.js?1633771374"></script>
    
        
            <script src="/js/mermaid.min.js?1633771374"></script>
        
        
            
        
        <script>
            if (mermaid) {
                mermaid.mermaidAPI.initialize( Object.assign( { "securityLevel": "antiscript" }, JSON.parse("{ \"startOnLoad\": true }"), { startOnLoad: false } ) );
            }
        </script>
    
    <script src="/js/relearn.js?1633771374"></script>
    

  </body>
</html>

